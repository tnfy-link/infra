global:
  scrape_interval: 15s # By default, scrape targets every 15 seconds.
  evaluation_interval: 15s # By default, scrape targets every 15 seconds.
  # scrape_timeout is set to the global default (10s).

  # Attach these labels to any time series or alerts when communicating with
  # external systems (federation, remote storage, Alertmanager).
  # external_labels:
  #     monitor: 'my-project'

# Load and evaluate rules in this file every 'evaluation_interval' seconds.
rule_files:
  - "alert.rules.yml"

# alert
alerting:
  alertmanagers:
    - scheme: http
      static_configs:
        - targets:
            - "alertmanager:9093"
# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.

  - job_name: "prometheus"

    # Override the global default and scrape targets from this job every 5 seconds.
    scrape_interval: 15s

    static_configs:
      - targets: ["localhost:9090"]

  # Create a job for Docker Swarm containers.
  - job_name: "dockerswarm"
    dockerswarm_sd_configs:
      - host: unix:///var/run/docker.sock
        role: tasks
        filters:
          - name: label
            values:
              - prometheus.io/scrape=true

    relabel_configs:
      # Only keep running tasks
      - source_labels: [__meta_dockerswarm_task_desired_state]
        regex: running
        action: keep

      # Only keep tasks in internal network
      - source_labels: [__meta_dockerswarm_network_name]
        regex: ^internal$
        action: keep

      # Use node hostname + task slot to disambiguate replicas
      - source_labels:
          [__meta_dockerswarm_node_hostname, __meta_dockerswarm_task_slot]
        regex: (.*);(.*)
        replacement: $1/task-$2
        target_label: instance

      - source_labels: [__meta_dockerswarm_service_label_prometheus_io_port]
        regex: (\d+)
        target_label: __port__
        replacement: $1
        action: replace

      # Drop targets missing or producing an empty __port__ (missing or non-numeric prometheus.io/port)
      - source_labels: [__port__]
        regex: ^$
        action: drop

      # Strip port from task address to isolate IP
      - source_labels: [__address__]
        target_label: __address__
        regex: (.+):(\d+)
        replacement: $1
        action: replace

      # Reconstruct address using IP + custom port from label
      # (Multiple source_labels are joined with semicolons)
      - source_labels: [__address__, __port__]
        target_label: __address__
        regex: (.+);(\d+)
        replacement: $1:$2
        action: replace

      # Set the job name based on the service label
      - source_labels: [__meta_dockerswarm_service_label_prometheus_io_job]
        target_label: job
        regex: (.+)
        replacement: $1

      # Set service_name label
      - source_labels: [__meta_dockerswarm_service_name]
        target_label: service_name
